<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录自己学习成长的点滴。"><title>深入学习Netty-认识Netty | 指尖上的律动</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">深入学习Netty-认识Netty</h1><a id="logo" href="/.">指尖上的律动</a><p class="description">Always on the way of programming.</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">深入学习Netty-认识Netty</h1><div class="post-meta">Sep 11, 2018<span> | </span><span class="category"><a href="/categories/深入学习Netty/">深入学习Netty</a></span></div><div class="post-content"><h1 id="Netty是什么"><a href="#Netty是什么" class="headerlink" title="Netty是什么"></a>Netty是什么</h1><p>Netty是由JBOSS提供的一个Java开源网络应用框架。Netty提供异步的、事件驱动的网络应用程序框架和工具，用以快速开发高性能、高可靠性的网络服务器和客户端程序。</p>
<a id="more"></a>
<p>Netty提供了一种新的方式来开发网络应用程序，这种新的方式使它很容易使用和具有很强的扩展性。Netty的内部实现是很复杂的，但是Netty封装了JDK底层BIO和NIO模型，提供了简单易用的API，同时Netty自带编解码器解决拆包粘包问题，实现了网络处理中逻辑解耦，让用户只用关心实际的业务逻辑。</p>
<p>Netty是完全基于NIO实现的，Netty的所有IO操作都是异步非阻塞的，通过Future-Listener机制，用户可以方便的主动获取或者通过通知机制获得IO操作结果。</p>
<p>Netty是当前非常流行的NIO框架，它的健壮性、高性能、可定制性以及可扩展性在同类框架都是首屈一指的。业界很多著名的开源框架都是基于Netty构建，如主流的RPC通信框架Dubbo、消息中间件RocketMQ、分布式协调服务Zookeeper、Hadoop的RPC框架Avro等等。</p>
<p>那么Netty的性能为什么会这么高呢？主要是因为其内部Reactor模型的实现。</p>
<hr>
<h1 id="Reactor模型"><a href="#Reactor模型" class="headerlink" title="Reactor模型"></a>Reactor模型</h1><p>Reactor设计模式是Event-Driven Drchitecture的一种实现方式，用以处理多个客户端并发的向服务端请求服务的场景。</p>
<h2 id="何为Reactor线程模型"><a href="#何为Reactor线程模型" class="headerlink" title="何为Reactor线程模型"></a>何为Reactor线程模型</h2><p>Reactor模式是事件驱动的，Wikipedia上说：“The reactor design pattern is an event handling pattern for handling service requests delivered concurrently by one or more inputs. The service handler then demultiplexes the incoming requests and dispatches them synchronously to associated request handlers.”。从这个描述中，我们知道Reactor模式首先是事件驱动的，有一个或多个并发输入源，有一个Service Handler，有多个Request Handlers；这个Service Handler会同步的将输入的请求（Event）多路复用的分发给相应的Request Handler。</p>
<p><img src="/images/20180911/reactor.png" alt="Reactor线程模型"></p>
<p>从结构上，这有点类似生产者消费者模式，即有一个或多个生产者将事件放入一个Queue中，而一个或多个消费者主动的从这个Queue中Poll事件来处理；而Reactor模式则并没有Queue来做缓冲，每当一个Event输入到Service Handler之后，该Service Handler会立刻的根据不同的Event类型将其分发给对应的Request Handler来处理。</p>
<h2 id="Netty的Reactor线程模型"><a href="#Netty的Reactor线程模型" class="headerlink" title="Netty的Reactor线程模型"></a>Netty的Reactor线程模型</h2><p>Netty的Reactor模型主要由多路复用器(Acceptor)、事件分发器(Dispatcher)、事件处理器(Handler)三部分组成，Netty中典型的实现有三种：</p>
<h3 id="1-单线程模型"><a href="#1-单线程模型" class="headerlink" title="1. 单线程模型"></a>1. 单线程模型</h3><p>单线程模型是最简单的Reactor模型，所有I/O操作都由一个线程完成，即多路分离套接字、Accept新连接和新连接数据处理都是在一个Reactor线程上完成的。</p>
<p><img src="/images/20180911/reactor_1.png" alt="Reactor单线程模型"></p>
<p>对于一些小容量应用场景，可以使用单线程模型。但是对于高负载、大并发的场景，由于是单线程，无法处理成百上千的连接，另外无法使用多核资源，实际中少使用。</p>
<h3 id="2-多线程模型"><a href="#2-多线程模型" class="headerlink" title="2. 多线程模型"></a>2. 多线程模型</h3><p>为了解决单线程模型存在的一些问题，演化出来Reactor多线程模型。</p>
<p><img src="/images/20180911/reactor_2.png" alt="Reactor多线程模型"></p>
<p>多线程模型有如下特点：</p>
<ul>
<li>有一个专门的Acceptor线程用于监听服务端，接收客户端的TCP连接请求；</li>
<li>所有的网络IO读写操作都是由一个专门的NIO线程池负责，将Accept新连接和事件处理分开，由这些NIO线程负责消息的读取、解码、编码和发送；</li>
<li>一个NIO线程可以同时处理多条链路，但是一个链路只能对应一个NIO线程，防止发生并发操作问题。</li>
</ul>
<p>在绝大多数场景下，Reactor多线程模型都可以满足性能需求；但是，在极特殊应用场景中，一个NIO线程负责监听和处理所有的客户端连接可能会存在性能问题。例如百万客户端并发连接，或者服务端需要对客户端的握手消息进行安全认证，认证本身非常损耗性能。在这类场景下，单独一个Acceptor线程可能会存在性能不足问题，为了解决性能问题，产生了第三种Reactor线程模型-主从Reactor多线程模型。</p>
<h3 id="3-主从多线程模型"><a href="#3-主从多线程模型" class="headerlink" title="3. 主从多线程模型"></a>3. 主从多线程模型</h3><p>主从多线程模型中接收客户端连接的不再是1个单独的NIO线程，而是一个独立的NIO线程池。Acceptor接收到客户端TCP连接请求处理完成后（可能包含接入认证等），将新创建的SocketChannel注册到I/O线程池（sub reactor线程池）的某个I/O线程上，由它负责SocketChannel的读写和编解码工作。</p>
<p><img src="/images/20180911/reactor_3.png" alt="Reactor主从线程模型"></p>
<p>通常Acceptor线程池只用于客户端的登录、握手和安全认证，一旦链路建立成功，就将链路注册到后端subReactor线程池的I/O线程上，由I/O线程负责后续的I/O操作。</p>
<p>第三种模型比起第二种模型，是将Reactor分成两部分，mainReactor负责监听server socket，accept新连接，并将建立的socket分派给subReactor。subReactor负责多路分离已连接的socket，读写网 络数据，对业务处理功能，其扔给worker线程池完成。通常，subReactor个数上可与CPU个数等同。</p>
<p>事实上，Netty的线程模型并非固定不变，在启动辅助类中创建不同的EventLoopGroup实例并通过适当的参数配置，就可以支持上述三种Reactor线程模型。正是因为Netty对Reactor线程模型的支持提供了灵活的定制能力，所以可以满足不同业务场景的性能需求。</p>
<hr>
<h1 id="Netty核心组件"><a href="#Netty核心组件" class="headerlink" title="Netty核心组件"></a>Netty核心组件</h1><p>Netty中的核心组件包括Channel、EventLoop、ChannelHandler、ChannelPipeLine、ByteBuf、Bootstrap、ServerBootstrap。</p>
<h2 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h2><p>在Netty里，Channel是通讯的载体，Channel代表一个Socker链接或者其他的IO相关组件。Channel用于完成基础的IO操作，如绑定、连接、读写等，Channel提供了一组API，极大地简化了直接与Socket进行操作的复杂性</p>
<h2 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a>EventLoop</h2><p>EventLoop是一个事件循环，可以理解为一个线程，用来处理连接的生命周期中所发生的事件，如服务端接受客户端连接的接入，处理每个已接入连接上数据流的读写。EventLoop定义了处理在连接过程中发生的事件的核心抽象，一个EventLoop可以为多个Channel服务。</p>
<h2 id="ChannelHandler"><a href="#ChannelHandler" class="headerlink" title="ChannelHandler"></a>ChannelHandler</h2><p>从应用开发者看来，ChannelHandler是最重要的组件，其中存放用来处理进站和出站数据的用户逻辑。ChannelHandler的方法被网络事件触发，ChannelHandler可以用于几乎任何类型的操作，如将数据从一种格式转换为另一种格式或处理抛出的异常。例如，其子接口ChannelInboundHandler，接受进站的事件和数据以便被用户定义的逻辑处理，或者当响应所连接的客户端时刷新ChannelInboundHandler的数据。</p>
<h2 id="ChannelPipeLine"><a href="#ChannelPipeLine" class="headerlink" title="ChannelPipeLine"></a>ChannelPipeLine</h2><p>Netty 在事件处理上，是通过ChannelPipeline来控制事件流，通过调用注册其上的一系列ChannelHandler来处理事件。ChannelPipeline为ChannelHandler链提供了一个容器并定义了用于沿着链传播入站和出站事件流的API。当创建Channel时，会自动创建一个附属的ChannelPipeline。数据可以沿着处理链进行传递。</p>
<h2 id="ByteBuf"><a href="#ByteBuf" class="headerlink" title="ByteBuf"></a>ByteBuf</h2><p>ByteBuf是一个存储字节的容器，是对JDK底层NIO中ByteBuffer的封装，最大特点就是使用方便，它既有自己的读索引和写索引，方便你对整段字节缓存进行读写，也支持get/set，方便你对其中每一个字节进行读写。通常有Heap Buffer、Direct Buffer、Composite Buffer三种模式。<br>其中Direct Buffer是ByteBuf中一种常用模式，它的内存分配都发生在堆外的直接内存中，免去了中间交换的内存拷贝, 提升IO处理速度。</p>
<h2 id="Bootstrap-和-ServerBootstrap"><a href="#Bootstrap-和-ServerBootstrap" class="headerlink" title="Bootstrap 和 ServerBootstrap"></a>Bootstrap 和 ServerBootstrap</h2><p>Bootstrap 和 ServerBootstrap是创建Netty客户端和服务端的引导辅助类，负责服务端和客户端创建以及初始化时的一些参数设置，如指定Channel类型，配置ChannelHandler等。</p>
<hr>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a href="https://www.jianshu.com/p/1123c9164e3e" target="_blank" rel="noopener">Netty入门简介</a></li>
<li><a href="https://www.jianshu.com/p/b9f3f6a16911" target="_blank" rel="noopener">Netty入门教程</a></li>
<li><a href="https://blog.csdn.net/summerZBH123/article/details/79344226" target="_blank" rel="noopener">Netty中的基本组件及关系</a></li>
</ol>
</div><div class="tags"><a href="/tags/Netty/">Netty</a><a href="/tags/NIO/">NIO</a><a href="/tags/Reactor/">Reactor</a></div><div class="post-nav"><a class="pre" href="/2018/11/14/广播地址计算/">广播地址计算</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.mikewoo.top"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/深入学习Kafka/">深入学习Kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/深入学习Netty/">深入学习Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络编程/">网络编程</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/TCP-IP/" style="font-size: 15px;">TCP/IP</a> <a href="/tags/BROADCAST/" style="font-size: 15px;">BROADCAST</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/Socket/" style="font-size: 15px;">Socket</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/Reactor/" style="font-size: 15px;">Reactor</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/01/30/深入学习Kafka-初始Kafka/">深入学习Kafka-初始Kafka</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/14/深入学习Netty-Socket服务器与客户端实现/">深入学习Netty-Socket服务器与客户端实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/14/广播地址计算/">广播地址计算</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/11/深入学习Netty-认识Netty/">深入学习Netty-认识Netty</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">指尖上的律动.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>